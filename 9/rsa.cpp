/*************************************************************************
 > File Name: ez_rsa.cpp
 > Author: Guaji
 > Mail: rdwentao@163.com 
 > Created Time: Sun 10 May 2020 08:36:10 PM CST
 ************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <gmpxx.h>
#include "ari.h"

int encode(mpz_t m,mpz_t n ,mpz_t e,mpz_t c);
int decode1(mpz_t c,mpz_t n ,mpz_t d,mpz_t m);
int decode2(mpz_t m,mpz_t p,mpz_t q,mpz_t dp,mpz_t dq,mpz_t qInv ,mpz_t c);

int main(){
    mpz_t m,n,e,c,d;
    mpz_inits(m,n,e,c,d,NULL);
    mpz_set_str(e,"65537",10);
    mpz_set_str(n,"14953675343867353426809060370006891177760987573732937371488768560187145296888650041003182946001095628989687061173031985216583916059762574269128737466587282372315819810249516946573044111283328982026499587609586839781730225917510353627078856397168637287759073411792948019154291414251989402563051827143513951034201270457074213649870630723249745292981533643403007903320536747157832568038460060349422511613978921687724357522883056079709905174793284735623555232990194070495865172272599488362296023436021218619172958312433629927109475109223294364852366506466389535524669550119036246185378321426839076994963607208081944039707",10);
    mpz_set_str(c,"14547056508539528406454817034594406211736709656537757670384239761555684470730284241676185110481675495393250182201033222324610191649967551648750411152736019966635762838073504101343153448596635084447519880793383076521236614930372193891128668248686108812231937872131311411022223333151760828704935123411889397217677936751551123368844319093735025357897704806801632395108857300097793988801676848882709308391869144230162872371158503851527419057639602188625588881822707899682572595123414348551799208580625379149093820180531675725298720444314718204842568472240076802053620149504633626285512551928021561892956355073617884414120",10);
    mpz_set_str(m,"63737463727970746f7b7930755f7233616c31795f6b6e30775f636f6d6d306e5f6d3064756c75735f61747461636b7d",16);

    encode(m, n, e, c);
    gmp_printf("%Zd\n",c);

    mpz_clears(m,n,d,e,c,NULL);
    return 0;
}


int encode(mpz_t m,mpz_t n ,mpz_t e,mpz_t c){
    if(mpz_cmp(m,n)>=0){
        printf("Too long message");
        return 0;
    }
    fast_pow_mod(c, m, e, n); 
    return 1;
}

int decode1(mpz_t c,mpz_t n ,mpz_t d,mpz_t m){
    if(mpz_cmp(c,n)>=0){
        printf("Too long c");
        return 0;
    }
    fast_pow_mod(m, c, d, n); 
    return 1;
}

int decode2(mpz_t c,mpz_t p,mpz_t q,mpz_t dp,mpz_t dq,mpz_t qInv ,mpz_t m){
    mpz_t n,m1,m2,h;
    mpz_inits(n,m1,m2,h,NULL);
    mpz_mul(n,p,q);
    if(mpz_cmp(c,n)>=0){
        printf("Too long c");
        return 0;
    }
    fast_pow_mod(m1, c, dp, p);
    fast_pow_mod(m2, c, dq, q);

    mpz_sub(h,m1,m2);
    mpz_mul(h,h,qInv);
    mpz_mul(m,q,h);
    mpz_add(m,m,m2);

    mpz_clears(n,m1,m2,h,NULL);
    return 1;
}
